<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF 테두리 표시</title>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+KR:wght@100..900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">


    <link rel="stylesheet" th:href="@{/css/extract/extractor.css}"><!-- 추출 -->

    <style>
        #pdf-container {
            position: relative;
            display: block;
            border: 1px solid black;
        }
        canvas {
            display: block;
        }
        .highlight-box {
            position: absolute;
            border: 2px solid red;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }
        .highlight-box:hover {
            background-color: rgba(255, 0, 0, 0.5);
        }
    </style>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
<input type="file" id="file-input-d" style="display: none;">
<h1>PDF 테두리 표시</h1>
<div class="extract-ele-ar c-s-c" id="extract-res"></div>
<div id="pdf-container"></div>

<script>
    const pdfUrl = "/25_O_odd.pdf";
    const jsonUrl = "/res_json.json";

    const pdfContainer = document.getElementById("pdf-container");

    let formData = new FormData();
    formData.append("pdf", pdfUrl);

        $.ajax({
        url: "/member/extract/auto",
        method: "POST",
        processData: false,
        contentType: false,
        data: formData,
        success: function (response) {

            if(response == 'err'){
                alert("서버 에러입니다.");
                return;
            }

            $('#extract-res').css('display' , 'flex');
            $('#extract-res').append(response);

            console.log("파일 업로드 성공:", response);
        },
        error: function (xhr, status, error) {
            alert("서버 에러");
        },
    });

    pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
        fetch(jsonUrl)
            .then(response => response.json())
            .then(data => {
                const processedRects = new Map(); // 페이지별 테두리 저장

                // JSON 데이터를 페이지별로 정리
                data.forEach(rect => {
                    if (!processedRects.has(rect.page)) {
                        processedRects.set(rect.page, new Set());
                    }
                    const rectKey = `${rect.x}-${rect.y}-${rect.width}-${rect.height}`;
                    processedRects.get(rect.page).add(rectKey);
                });

                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    if (!processedRects.has(pageNum)) continue;

                    pdf.getPage(pageNum).then(page => {
                        const viewport = page.getViewport({ scale: 1.5 });
                        const pageWrapper = document.createElement("div");
                        pageWrapper.style.position = "relative";
                        pageWrapper.style.width = `${viewport.width}px`;
                        pageWrapper.style.height = `${viewport.height}px`;
                        pdfContainer.appendChild(pageWrapper);

                        const canvas = document.createElement("canvas");
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        pageWrapper.appendChild(canvas);
                        const ctx = canvas.getContext("2d");

                        const renderContext = {
                            canvasContext: ctx,
                            viewport: viewport
                        };
                        page.render(renderContext);

                        processedRects.get(pageNum).forEach(rectKey => {
                            const [x, y, width, height] = rectKey.split("-").map(Number);

                            const div = document.createElement("div");
                            div.className = "highlight-box";
                            div.style.left = `${x * 1.5}px`;
                            div.style.top = `${y * 1.5}px`;
                            div.style.width = `${width * 1.5}px`;
                            div.style.height = `${height * 1.5}px`;
                            div.style.position = "absolute";
                            div.style.zIndex = "10";
                            div.style.pointerEvents = "auto";
                            pageWrapper.appendChild(div);
                        });
                    });
                }
            });
    });


$(document).on('click', '.open-folder-btn', function () {
    $('#file-input-d').click();
});

</script>
</body>
</html>
